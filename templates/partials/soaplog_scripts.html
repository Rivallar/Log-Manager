<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let currentResults = [];
let currentPage = 1;
const resultsPerPage = 20;

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    flatpickr("#startDate", {
        dateFormat: "Y-m-d",
        defaultDate: weekAgo,
        maxDate: today
    });

    flatpickr("#endDate", {
        dateFormat: "Y-m-d",
        defaultDate: today,
        maxDate: today
    });

    document.getElementById('searchForm').addEventListener('submit', handleSearch);
    document.getElementById('clearForm').addEventListener('click', clearForm);
    document.getElementById('exportExcel').addEventListener('click', exportExcel);
});

async function handleSearch(e) {
    e.preventDefault();

    const searchParams = {
        msisdn: document.getElementById('msisdn').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        node_type: document.getElementById('node_type').value
    };

    if (!searchParams.msisdn || !searchParams.node_type) {
        showError('MSISDN and Node Type are required');
        return;
    }

    showLoading();
    hideError();

    try {
        const response = await fetch('/api/get_soaplogs?' + new URLSearchParams(searchParams));
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to fetch logs');
        }
        const results = await response.json();
        currentResults = results;
        currentPage = 1;
        displayResults();
    } catch (error) {
        showError(error.message);
    } finally {
        hideLoading();
    }
}

function displayResults() {
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = startIndex + resultsPerPage;
    const pageResults = currentResults.slice(startIndex, endIndex);

    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';

    if (pageResults.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No logs found for the specified criteria</p>
                </td>
            </tr>
        `;
    } else {
        pageResults.forEach(log => {
            const row = document.createElement('tr');
            row.className = log.if_error ? 'error-row' : 'success-row';
            row.innerHTML = `
                <td>${formatDateTime(log.log_time)}</td>
                <td>${log.cmd_code}</td>
                <td>${log.user_id}</td>
                <td>${log.node_name}</td>
                <td>${log.if_error ? 
                        '<span class="badge bg-danger status-badge"><i class="fas fa-times me-1"></i>Error</span>' : 
                        '<span class="badge bg-success status-badge"><i class="fas fa-check me-1"></i>Success</span>'
                    }
                </td>
                <td>${log.error_description || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showDetails('${log.log_time}', '${log.cmd_code}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    renderPaginationSoapLog();
    document.getElementById('resultsSection').style.display = 'block';
}

function showDetails(logTime, cmdCode) {
    const log = currentResults.find(l => l.log_time === logTime && l.cmd_code === cmdCode);
    if (!log) return;
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Command Code:</strong></td><td>${log.cmd_code}</td></tr>
                    <tr><td><strong>User ID:</strong></td><td>${log.user_id}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>
                        ${log.if_error ? 
                            '<span class="badge bg-danger">Error</span>' : 
                            '<span class="badge bg-success">Success</span>'
                        }
                    </td></tr>
                    <tr><td><strong>Error Description:</strong></td><td>${log.error_description || '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Network Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Node Name:</strong></td><td>${log.node_name}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>SOAP Request</h6>
                <div class="bg-light p-3 rounded">
                    <pre style="white-space: pre-wrap; word-break: break-all;">${escapeHtml(log.request)}</pre>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Timestamp</h6>
                <p class="text-muted">${formatDateTime(log.log_time)}</p>
            </div>
        </div>
    `;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function exportExcel() {
    if (currentResults.length === 0) return;
    // Prepare data for Excel
    const headers = ['Time', 'Command Code', 'User ID', 'Node Name', 'Status', 'Error Description', 'SOAP Request'];
    const data = currentResults.map(log => [
        formatDateTime(log.log_time),
        log.cmd_code,
        log.user_id,
        log.node_name,
        log.if_error ? 'Error' : 'Success',
        log.error_description || '',
        log.request
    ]);
    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    // Set column widths
    const colWidths = [
        { wch: 20 }, // Time
        { wch: 15 }, // Command Code
        { wch: 15 }, // User ID
        { wch: 15 }, // Node Name
        { wch: 10 }, // Status
        { wch: 30 }, // Error Description
        { wch: 40 }  // SOAP Request
    ];
    ws['!cols'] = colWidths;
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'SOAP Logs');
    // Generate Excel file
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    // Download file
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'soap_logs.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function clearForm() {
    document.getElementById('searchForm').reset();
    document.getElementById('resultsSection').style.display = 'none';
    hideError();
}
function showLoading() {
    document.getElementById('loadingSection').style.display = 'block';
}
function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
}
function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
}
function hideError() {
    document.getElementById('errorSection').style.display = 'none';
}
function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString();
}


function onPageChangeSoapLog(page) {
    currentPage = page;
    displayResults();
}

function renderPaginationSoapLog() {
    updatePagination(currentResults, resultsPerPage, currentPage, onPageChangeSoapLog);
    updatePaginationInfo(currentResults, resultsPerPage, currentPage);
}
// Call renderPaginationSoapLog() after updating results or page
</script>