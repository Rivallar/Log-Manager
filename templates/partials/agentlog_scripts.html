<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let currentResults = [];
let currentPage = 1;
const resultsPerPage = 20;

// ... existing code ...

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    flatpickr("#startDate", {
        dateFormat: "Y-m-d",
        defaultDate: weekAgo,
        maxDate: today
    });
    
    flatpickr("#endDate", {
        dateFormat: "Y-m-d",
        defaultDate: today,
        maxDate: today
    });
    
    document.getElementById('searchForm').addEventListener('submit', handleSearch);
    document.getElementById('clearForm').addEventListener('click', clearForm);
    document.getElementById('exportExcel').addEventListener('click', exportExcel);
});

// ... existing code ...

async function handleSearch(e) {
    e.preventDefault();
    
    const searchParams = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value
    };
    
    // Only add MSISDN and IMSI if they have actual values
    const msisdnValue = document.getElementById('msisdn').value.trim();
    const imsiValue = document.getElementById('imsi').value.trim();
    
    if (msisdnValue) {
        searchParams.msisdn = parseInt(msisdnValue);
    }
    
    if (imsiValue) {
        searchParams.imsi = parseInt(imsiValue);
    }
    
    if (!searchParams.hasOwnProperty('msisdn') && !searchParams.hasOwnProperty('imsi')) {
        showError('At least one of MSISDN or IMSI must be provided');
        return;
    }
    
    showLoading();
    hideError();
    
    try {
        const response = await fetch('/api/get_agentlogs?' + new URLSearchParams(searchParams));
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to fetch logs');
        }
        
        const results = await response.json();
        currentResults = results;
        currentPage = 1;
        
        displayResults();
        
    } catch (error) {
        showError(error.message);
    } finally {
        hideLoading();
    }
}

// ... existing code ...

function displayResults() {
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = startIndex + resultsPerPage;
    const pageResults = currentResults.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    
    if (pageResults.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No logs found for the specified criteria</p>
                </td>
            </tr>
        `;
    } else {
        pageResults.forEach(log => {
            const row = document.createElement('tr');
            row.className = log.if_error ? 'error-row' : 'success-row';
            
            row.innerHTML = `
                <td>${formatDateTime(log.log_time)}</td>
                <td><strong>${log.operator}</strong></td>
                <td>${log.msisdn || '-'}</td>
                <td>${log.imsi || '-'}</td>
                <td>
                    <span class="badge bg-secondary">${log.node_name}</span>
                    <br><small class="text-muted">${log.node_ip}</small>
                </td>
                <td>
                    <code class="text-sm">${log.command}</code>
                    <br><small class="text-muted">Code: ${log.cmd_code}</small>
                </td>
                <td>
                    ${log.if_error ? 
                        '<span class="badge bg-danger status-badge"><i class="fas fa-times me-1"></i>Error</span>' : 
                        '<span class="badge bg-success status-badge"><i class="fas fa-check me-1"></i>Success</span>'
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showDetails('${log.cmd_code}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    renderPaginationAgentLog();
    document.getElementById('resultsSection').style.display = 'block';
}

// ... existing code ...

function showDetails(cmdCode) {
    const log = currentResults.find(l => l.cmd_code === cmdCode);
    if (!log) return;
    
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Command Code:</strong></td><td>${log.cmd_code}</td></tr>
                    <tr><td><strong>Operator:</strong></td><td>${log.operator}</td></tr>
                    <tr><td><strong>Agent Type:</strong></td><td>${log.agent_type}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>
                        ${log.if_error ? 
                            '<span class="badge bg-danger">Error</span>' : 
                            '<span class="badge bg-success">Success</span>'
                        }
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Network Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Node Name:</strong></td><td>${log.node_name}</td></tr>
                    <tr><td><strong>Node IP:</strong></td><td>${log.node_ip}</td></tr>
                    <tr><td><strong>MSISDN:</strong></td><td>${log.msisdn || '-'}</td></tr>
                    <tr><td><strong>IMSI:</strong></td><td>${log.imsi || '-'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Command Details</h6>
                <div class="bg-light p-3 rounded">
                    <code>${log.command}</code>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Timestamp</h6>
                <p class="text-muted">${formatDateTime(log.log_time)}</p>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

// ... existing code ...

function exportExcel() {
    if (currentResults.length === 0) return;
    
    // Prepare data for Excel
    const headers = ['Time', 'Operator', 'MSISDN', 'IMSI', 'Node Name', 'Node IP', 'Command Code', 'Command', 'Status'];
    const data = currentResults.map(log => [
        formatDateTime(log.log_time),
        log.operator,
        log.msisdn || '',
        log.imsi || '',
        log.node_name,
        log.node_ip,
        log.cmd_code,
        log.command,
        log.if_error ? 'Error' : 'Success'
    ]);
    
    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    
    // Set column widths
    const colWidths = [
        { wch: 20 }, // Time
        { wch: 15 }, // Operator
        { wch: 12 }, // MSISDN
        { wch: 12 }, // IMSI
        { wch: 15 }, // Node Name
        { wch: 15 }, // Node IP
        { wch: 12 }, // Command Code
        { wch: 40 }, // Command
        { wch: 10 }  // Status
    ];
    ws['!cols'] = colWidths;
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Agent Logs');
    
    // Generate Excel file
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // Download file
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'agent_logs.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// ... existing code ...

function clearForm() {
    document.getElementById('searchForm').reset();
    document.getElementById('resultsSection').style.display = 'none';
    hideError();
}

function showLoading() {
    document.getElementById('loadingSection').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
}

function hideError() {
    document.getElementById('errorSection').style.display = 'none';
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString();
}
</script>