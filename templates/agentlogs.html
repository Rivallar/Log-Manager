{% extends "base.html" %}

{% block title %}Agent Logs - Log Manager{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .search-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 15px;
    }
    
    .results-card {
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .btn-search {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .error-row {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .success-row {
        background-color: rgba(40, 167, 69, 0.1) !important;
    }
    

    
    .pagination-info {
        font-size: 0.9rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="display-5 mb-4">
            <i class="fas fa-user-shield me-3"></i>Agent Logs
        </h1>
        <p class="lead text-muted">Query agent activity logs by date, MSISDN, and IMSI.</p>
    </div>
</div>



<!-- Search Form -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card search-card">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-search me-2"></i>Search Agent Logs
                </h5>
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="text" class="form-control datepicker" id="startDate" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="text" class="form-control datepicker" id="endDate" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="msisdn" class="form-label">MSISDN (Optional)</label>
                            <input type="number" class="form-control" id="msisdn" placeholder="Enter MSISDN">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="imsi" class="form-label">IMSI (Optional)</label>
                            <input type="number" class="form-control" id="imsi" placeholder="Enter IMSI">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-light btn-search">
                                <i class="fas fa-search me-2"></i>Search Logs
                            </button>
                            <button type="button" class="btn btn-outline-light ms-2" id="clearForm">
                                <i class="fas fa-times me-2"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="row mb-4" id="loadingSection" style="display: none;">
    <div class="col-12 text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Searching agent logs...</p>
    </div>
</div>

<!-- Results Section -->
<div class="row" id="resultsSection" style="display: none;">
    <div class="col-12">
        <div class="card results-card">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Search Results
                    </h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" id="exportExcel">
                            <i class="fas fa-file-excel me-1"></i>Export Excel
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="resultsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Operator</th>
                                <th>MSISDN</th>
                                <th>IMSI</th>
                                <th>Node</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="pagination-info">
                        Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalResults">0</span> results
                    </div>
                    <nav aria-label="Results pagination">
                        <ul class="pagination pagination-sm mb-0" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Alert -->
<div class="row mt-4" id="errorSection" style="display: none;">
    <div class="col-12">
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let currentResults = [];
let currentPage = 1;
const resultsPerPage = 20;

document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    
    flatpickr("#startDate", {
        dateFormat: "Y-m-d",
        defaultDate: weekAgo,
        maxDate: today
    });
    
    flatpickr("#endDate", {
        dateFormat: "Y-m-d",
        defaultDate: today,
        maxDate: today
    });
    
    document.getElementById('searchForm').addEventListener('submit', handleSearch);
    document.getElementById('clearForm').addEventListener('click', clearForm);
    document.getElementById('exportExcel').addEventListener('click', exportExcel);
});

async function handleSearch(e) {
    e.preventDefault();
    
    const searchParams = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value
    };
    
    // Only add MSISDN and IMSI if they have actual values
    const msisdnValue = document.getElementById('msisdn').value.trim();
    const imsiValue = document.getElementById('imsi').value.trim();
    
    if (msisdnValue) {
        searchParams.msisdn = parseInt(msisdnValue);
    }
    
    if (imsiValue) {
        searchParams.imsi = parseInt(imsiValue);
    }
    
    if (!searchParams.hasOwnProperty('msisdn') && !searchParams.hasOwnProperty('imsi')) {
        showError('At least one of MSISDN or IMSI must be provided');
        return;
    }
    
    showLoading();
    hideError();
    
    try {
        const response = await fetch('/api/get_agentlogs?' + new URLSearchParams(searchParams));
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || 'Failed to fetch logs');
        }
        
        const results = await response.json();
        currentResults = results;
        currentPage = 1;
        
        displayResults();
        
    } catch (error) {
        showError(error.message);
    } finally {
        hideLoading();
    }
}

function displayResults() {
    const startIndex = (currentPage - 1) * resultsPerPage;
    const endIndex = startIndex + resultsPerPage;
    const pageResults = currentResults.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';
    
    if (pageResults.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>No logs found for the specified criteria</p>
                </td>
            </tr>
        `;
    } else {
        pageResults.forEach(log => {
            const row = document.createElement('tr');
            row.className = log.if_error ? 'error-row' : 'success-row';
            
            row.innerHTML = `
                <td>${formatDateTime(log.log_time)}</td>
                <td><strong>${log.operator}</strong></td>
                <td>${log.msisdn || '-'}</td>
                <td>${log.imsi || '-'}</td>
                <td>
                    <span class="badge bg-secondary">${log.node_name}</span>
                    <br><small class="text-muted">${log.node_ip}</small>
                </td>
                <td>
                    <code class="text-sm">${log.command}</code>
                    <br><small class="text-muted">Code: ${log.cmd_code}</small>
                </td>
                <td>
                    ${log.if_error ? 
                        '<span class="badge bg-danger status-badge"><i class="fas fa-times me-1"></i>Error</span>' : 
                        '<span class="badge bg-success status-badge"><i class="fas fa-check me-1"></i>Success</span>'
                    }
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="showDetails('${log.cmd_code}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    updatePagination();
    updatePaginationInfo();
    document.getElementById('resultsSection').style.display = 'block';
}



function updatePagination() {
    const totalPages = Math.ceil(currentResults.length / resultsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
            pagination.appendChild(li);
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            const li = document.createElement('li');
            li.className = 'page-item disabled';
            li.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(li);
        }
    }
    
    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * resultsPerPage + 1;
    const endIndex = Math.min(currentPage * resultsPerPage, currentResults.length);
    
    document.getElementById('showingStart').textContent = currentResults.length > 0 ? startIndex : 0;
    document.getElementById('showingEnd').textContent = endIndex;
    document.getElementById('totalResults').textContent = currentResults.length;
}

function changePage(page) {
    const totalPages = Math.ceil(currentResults.length / resultsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayResults();
    }
}

function showDetails(cmdCode) {
    const log = currentResults.find(l => l.cmd_code === cmdCode);
    if (!log) return;
    
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Command Code:</strong></td><td>${log.cmd_code}</td></tr>
                    <tr><td><strong>Operator:</strong></td><td>${log.operator}</td></tr>
                    <tr><td><strong>Agent Type:</strong></td><td>${log.agent_type}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>
                        ${log.if_error ? 
                            '<span class="badge bg-danger">Error</span>' : 
                            '<span class="badge bg-success">Success</span>'
                        }
                    </td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Network Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Node Name:</strong></td><td>${log.node_name}</td></tr>
                    <tr><td><strong>Node IP:</strong></td><td>${log.node_ip}</td></tr>
                    <tr><td><strong>MSISDN:</strong></td><td>${log.msisdn || '-'}</td></tr>
                    <tr><td><strong>IMSI:</strong></td><td>${log.imsi || '-'}</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Command Details</h6>
                <div class="bg-light p-3 rounded">
                    <code>${log.command}</code>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Timestamp</h6>
                <p class="text-muted">${formatDateTime(log.log_time)}</p>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function exportExcel() {
    if (currentResults.length === 0) return;
    
    // Prepare data for Excel
    const headers = ['Time', 'Operator', 'MSISDN', 'IMSI', 'Node Name', 'Node IP', 'Command Code', 'Command', 'Status'];
    const data = currentResults.map(log => [
        formatDateTime(log.log_time),
        log.operator,
        log.msisdn || '',
        log.imsi || '',
        log.node_name,
        log.node_ip,
        log.cmd_code,
        log.command,
        log.if_error ? 'Error' : 'Success'
    ]);
    
    // Create workbook and worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    
    // Set column widths
    const colWidths = [
        { wch: 20 }, // Time
        { wch: 15 }, // Operator
        { wch: 12 }, // MSISDN
        { wch: 12 }, // IMSI
        { wch: 15 }, // Node Name
        { wch: 15 }, // Node IP
        { wch: 12 }, // Command Code
        { wch: 40 }, // Command
        { wch: 10 }  // Status
    ];
    ws['!cols'] = colWidths;
    
    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'Agent Logs');
    
    // Generate Excel file
    const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // Download file
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'agent_logs.xlsx';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}





function clearForm() {
    document.getElementById('searchForm').reset();
    document.getElementById('resultsSection').style.display = 'none';
    hideError();
}

function showLoading() {
    document.getElementById('loadingSection').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loadingSection').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorSection').style.display = 'block';
}

function hideError() {
    document.getElementById('errorSection').style.display = 'none';
}

function formatDateTime(dateTimeString) {
    const date = new Date(dateTimeString);
    return date.toLocaleString();
}
</script>
{% endblock %} 